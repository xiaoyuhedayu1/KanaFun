<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kana Speed Trainer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use a Japanese font for clear kana display -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #111827; /* gray-900 */
            min-height: 100vh;
            color: #f3f4f6; /* gray-100 */
        }
        
        /* App container styling */
        #app {
            min-height: 85vh; 
            max-width: 900px; 
            width: 95%;
            background-color: #1f2937; /* gray-800 */
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        @media (min-width: 1024px) {
            #app {
                max-width: 900px;
                margin: 2rem;
                height: auto;
                min-height: 800px;
            }
        }

        .timer-bar {
            height: 6px;
            border-radius: 3px;
            transition: width 0.05s linear;
        }
        
        .kana-char {
            line-height: 1.2;
            transition: all 0.2s;
        }

        /* Styling for the dynamic quiz display area */
        #current-kana.string-mode {
            height: auto;
            min-height: 8rem;
            font-size: 3rem;
            padding: 2rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            line-height: 1.2;
            background-color: #111827;
            border-radius: 0.75rem;
            border: 1px solid #374151;
        }
        #current-kana.single-mode {
            font-size: 9rem; 
            height: 11rem;
        }
        @media (min-width: 768px) {
            #current-kana.single-mode {
                font-size: 11rem;
            }
        }

        /* String Mode Spans */
        #current-kana span {
            padding: 0 0.15em;
            margin: 0 2px;
            display: inline-block;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        #current-kana span.string-correct { color: #10b981; opacity: 0.5; }
        #current-kana span.string-incorrect { color: #ef4444; border-bottom-color: #ef4444; }
        #current-kana span.string-target { 
            font-weight: 900; 
            color: #fff; 
            transform: scale(1.1); 
            border-bottom-color: #3b82f6;
        }
        #current-kana span.string-pending { color: #4b5563; }
        
        /* Input Field */
        #kana-input {
            background-color: #111827;
            border: 2px solid #374151;
            color: #f3f4f6;
        }
        #kana-input:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        #kana-input:disabled {
            background-color: #1f2937;
            border-color: #4b5563;
            color: #9ca3af;
            cursor: not-allowed;
        }

        /* Feedback Classes */
        .input-correct { border-color: #10b981 !important; background-color: #064e3b !important; }
        .input-incorrect { border-color: #ef4444 !important; background-color: #450a0a !important; animation: shake 0.3s; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Settings Card Styling */
        .kana-group-card {
            border: 1px solid #374151; 
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            user-select: none;
            background-color: #111827;
        }
        .kana-group-card:hover { border-color: #4b5563; }
        .kana-group-card.selected {
            background-color: #1e3a8a; /* dark blue */
            border-color: #3b82f6; 
            color: #93c5fd;
        }
        .kana-group-card.deselected {
            background-color: #111827; 
            border-color: #374151; 
            color: #6b7280;
        }

        /* Settings Panel */
        #settings-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            background-color: #1f2937;
            z-index: 50;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid #374151;
            overflow-y: auto;
            border-radius: 1rem;
        }
        
        #settings-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 40;
            backdrop-filter: blur(2px);
        }

        @media (min-width: 1024px) {
            #settings-panel {
                width: 70%;
                padding: 2.5rem;
            }
        }
        
        /* Simple Button */
        .btn-simple {
            background-color: #374151;
            color: #f3f4f6;
            transition: all 0.2s;
        }
        .btn-simple:hover {
            background-color: #4b5563;
        }
        .btn-primary {
            background-color: #2563eb;
            color: white;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #1d4ed8;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        
        /* Remove arrows from number input */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-0 md:p-4">

    <div id="app" class="flex flex-col overflow-hidden relative">
        
        <!-- INTRO VIEW -->
        <div id="intro-view" class="view flex flex-col items-center justify-center h-full p-8">
            <div class="max-w-2xl w-full text-center">
                <div class="mb-6">
                    <span class="text-7xl">üéå</span>
                </div>
                
                <h1 class="text-4xl md:text-5xl font-bold text-white mb-4 tracking-tight">
                    Kana Speed Trainer
                </h1>
                <p class="text-gray-400 text-lg mb-12">
                    Master Hiragana & Katakana
                </p>
                
                <div class="grid md:grid-cols-2 gap-6 text-left mb-12">
                    <div class="p-6 bg-gray-900 rounded-xl border border-gray-700 hover:border-blue-500 transition duration-300">
                        <h3 class="font-bold text-blue-400 text-xl mb-2">‚ö° Quiz Mode</h3>
                        <p class="text-gray-400 text-sm leading-relaxed">Single character identification. Classic flashcard style.</p>
                    </div>
                    <div class="p-6 bg-gray-900 rounded-xl border border-gray-700 hover:border-green-500 transition duration-300">
                        <h3 class="font-bold text-green-400 text-xl mb-2">üìö String Mode</h3>
                        <p class="text-gray-400 text-sm leading-relaxed">Type sequentially through strings of characters.</p>
                    </div>
                </div>
                
                <button onclick="changeView('trainer-view')" class="btn-primary w-full py-4 rounded-xl text-xl font-bold shadow-lg">
                    Start Training
                </button>
            </div>
        </div>

        <!-- TRAINER VIEW -->
        <div id="trainer-view" class="view hidden flex-1 flex flex-col justify-between h-full p-6 md:p-10 relative">
            
            <!-- Header Area -->
            <div class="flex-none">
                <div class="flex justify-between items-center mb-8">
                    <button onclick="changeView('intro-view')" class="text-gray-400 hover:text-white transition p-2 bg-gray-700/50 rounded-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path></svg>
                    </button>
                    <h1 class="text-sm font-bold text-gray-300 uppercase tracking-widest">Kana Trainer</h1>
                    
                    <div class="flex gap-2">
                        <!-- Pause Button -->
                        <button onclick="togglePause()" class="text-gray-400 hover:text-white transition p-2 bg-gray-700/50 rounded-lg">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </button>
                        <!-- Settings Button -->
                        <button onclick="toggleSettings(true)" class="text-gray-400 hover:text-white transition p-2 bg-gray-700/50 rounded-lg">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </button>
                    </div>
                </div>
                
                <!-- Timer Bar -->
                <div id="timer-mode" class="relative h-2 bg-gray-700 rounded-full w-full mb-2 overflow-hidden">
                    <div id="timer-bar" class="timer-bar bg-blue-500 absolute top-0 left-0 h-full"></div>
                </div>
                <p id="mode-info" class="text-xs text-gray-500 font-mono text-center mb-4 min-h-[1rem]"></p>
            </div>

            <!-- Quiz Display Area -->
            <div id="quiz-display" class="flex-1 flex flex-col items-center justify-center min-h-[30vh]">
                <div id="current-kana" class="kana-char font-bold text-white mb-4 flex items-center justify-center select-none whitespace-pre single-mode relative z-10">
                    <!-- Character renders here -->
                </div>
                
                <div class="bg-gray-700/50 px-3 py-1 rounded-full">
                    <p id="kana-type" class="text-xs font-bold text-gray-300 uppercase tracking-widest">HIRAGANA</p>
                </div>
            </div>

            <!-- Input Area -->
            <div class="flex-none max-w-sm mx-auto w-full mb-8 relative z-20 flex flex-col gap-3">
                <input 
                    type="text" 
                    id="kana-input" 
                    class="w-full px-4 py-4 rounded-xl text-2xl text-center focus:outline-none transition duration-150 font-bold placeholder-gray-600 disabled:opacity-75"
                    placeholder="Type Romaji" 
                    autofocus 
                    autocomplete="off" 
                    autocorrect="off" 
                    autocapitalize="off" 
                    spellcheck="false"
                    onfocus="this.select()" 
                    oninput="handleInput()"
                >
                
                <!-- Skip Button -->
                <button onclick="skipQuestion()" class="w-full py-2 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg text-sm font-semibold transition">
                    Skip Question (Show Answer) ‚è≠Ô∏è
                </button>

                <!-- Instant Feedback -->
                <div id="feedback" class="h-6 text-lg font-bold text-center transition-all duration-200 opacity-0 transform translate-y-2"></div>
            </div>
            
            <!-- Stats Footer -->
            <div class="flex-none">
                <div class="grid grid-cols-3 gap-2 bg-gray-900 rounded-xl p-4 mb-6 max-w-2xl mx-auto border border-gray-700">
                    <div class="flex flex-col items-center">
                        <span class="text-[10px] uppercase tracking-wider text-gray-500 font-bold">Score</span>
                        <span id="score" class="font-mono text-xl text-green-500">0</span>
                    </div>
                    <div class="flex flex-col items-center border-l border-gray-700">
                        <span class="text-[10px] uppercase tracking-wider text-gray-500 font-bold">Streak</span>
                        <span id="streak" class="font-mono text-xl text-yellow-500">0</span>
                    </div>
                    <div class="flex flex-col items-center border-l border-gray-700">
                        <span class="text-[10px] uppercase tracking-wider text-gray-500 font-bold">Mistakes</span>
                        <span id="mistakes" class="font-mono text-xl text-red-500">0</span>
                    </div>
                </div>

                <!-- Toggle Buttons -->
                <div class="flex justify-center space-x-4 mb-2">
                    <button id="toggle-string-mode" onclick="toggleStringModeUI()" class="px-4 py-2 bg-gray-700 text-gray-200 rounded-lg text-sm font-semibold hover:bg-gray-600 transition flex items-center gap-2">
                        <span>üìö</span> String Mode: OFF
                    </button>
                    <!-- Review Mode Toggle -->
                    <button id="review-mode-btn" onclick="toggleReviewMode()" class="hidden px-4 py-2 bg-red-900/30 border border-red-900 text-red-400 rounded-lg text-sm font-semibold hover:bg-red-900/50 transition flex items-center gap-2">
                        <span>üöë</span> Review (<span id="mistake-count-btn">0</span>)
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Results Modal (String Mode) -->
        <div id="results-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4 transition-opacity duration-300">
            <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 max-w-md w-full text-center border border-gray-700">
                <div class="text-5xl mb-4">üéâ</div>
                <h3 class="text-2xl font-bold text-white mb-6">Round Complete</h3>
                
                <!-- Round Stats Summary -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-900/50 p-4 rounded-xl border border-gray-700/50 flex flex-col items-center">
                        <p class="text-xs text-gray-500 uppercase font-bold mb-1">String Length</p>
                        <p id="str-total-length" class="text-3xl font-bold text-white font-mono">0</p>
                    </div>
                    <div class="bg-gray-900/50 p-4 rounded-xl border border-gray-700/50 flex flex-col items-center">
                        <p class="text-xs text-gray-500 uppercase font-bold mb-1">Correct Kana</p>
                        <p id="str-correct-count" class="text-3xl font-bold text-green-400 font-mono">0</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-8 bg-gray-900 p-4 rounded-xl border border-gray-700 text-left">
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-bold">Time</p>
                        <p id="str-time-taken" class="text-lg font-mono text-white">0.00s</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-bold">WPM</p>
                        <p id="str-wpm" class="text-lg font-mono text-blue-400">0</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-bold">Accuracy</p>
                        <p id="str-accuracy" class="text-lg font-mono text-green-400">0%</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-bold">Mistakes</p>
                        <p id="str-mistyped-kana" class="text-lg font-mono text-red-400">0</p>
                    </div>
                </div>
                
                <button onclick="closeResultsModal()" class="btn-primary w-full py-3 rounded-xl font-bold">
                    Next Round
                </button>
            </div>
        </div>
        
        <!-- Pause Overlay -->
        <div id="pause-overlay" class="absolute inset-0 bg-gray-900/90 z-40 hidden flex flex-col items-center justify-center backdrop-blur-sm transition-opacity duration-200">
            <h2 class="text-5xl font-bold text-white mb-8 tracking-tighter">PAUSED</h2>
            <div class="text-center mb-8">
                <p class="text-gray-400 mb-2">Take a breath üçµ</p>
            </div>
            <button onclick="togglePause()" class="btn-primary px-10 py-4 rounded-2xl text-xl font-bold shadow-xl border-t border-blue-400">
                Resume
            </button>
        </div>

        <!-- Settings Overlay -->
        <div id="settings-overlay" class="hidden" onclick="toggleSettings(false)"></div>

        <!-- Settings Panel -->
        <div id="settings-panel" class="hidden flex flex-col relative">
            <!-- Close Button Top Right -->
            <button onclick="toggleSettings(false)" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>

            <div class="flex justify-center items-center mb-8 flex-none pt-4">
                <h2 class="text-2xl font-bold text-white tracking-tight">Configuration</h2>
            </div>

            <div class="flex-1 overflow-y-auto pr-2 px-4">
                <!-- Game Options -->
                <section class="mb-10">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">Game Options</h3>
                    
                    <div class="space-y-6 bg-gray-900 p-6 rounded-xl border border-gray-700">
                        <!-- Timer Toggle -->
                        <div class="flex items-center justify-between">
                            <span class="font-bold text-gray-300">‚è≥ Timer Active</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="timer-toggle" checked class="sr-only peer" onchange="toggleCustomTimeInput()">
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
        
                        <!-- Time Limit Input -->
                        <div id="custom-time-container" class="transition-all duration-300 overflow-hidden max-h-20">
                            <div class="flex items-center justify-between border-l-2 border-blue-500 pl-4 py-1">
                                <label class="text-xs font-bold text-gray-400 uppercase">Seconds per Kana</label>
                                <input type="number" id="timer-limit-input" value="3.0" min="0.5" max="30" step="0.5" class="w-20 p-2 bg-gray-800 border border-gray-600 rounded-lg text-center font-mono text-white text-lg focus:outline-none focus:border-blue-500 transition">
                            </div>
                        </div>
        
                        <!-- String Length -->
                        <div class="pt-2">
                            <div class="flex items-center justify-between mb-4">
                                <label class="font-bold text-gray-300">üìú String Length</label>
                            </div>
                            <div class="flex items-center justify-between bg-gray-800 p-1 rounded-lg border border-gray-700">
                                <button onclick="adjustStringLength(-1)" class="w-12 h-10 bg-gray-700 text-gray-300 hover:text-white rounded-md transition">-</button>
                                <!-- Changed span to Input for unlimited length -->
                                <input type="number" id="string-len-input" value="3" min="2" class="font-mono text-xl text-blue-400 w-20 text-center bg-transparent border-none focus:outline-none focus:ring-0 p-0 appearance-none" oninput="setStringLength(this.value)">
                                <button onclick="adjustStringLength(1)" class="w-12 h-10 bg-gray-700 text-gray-300 hover:text-white rounded-md transition">+</button>
                            </div>
                        </div>
                    </div>
                </section>
    
                <!-- Kana Selection -->
                <section>
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">Deck Selection</h3>

                    <div class="flex justify-end space-x-2 mb-4">
                        <button onclick="toggleAllScripts(true)" class="text-xs px-3 py-1 bg-green-900/30 text-green-400 border border-green-900 rounded hover:bg-green-900/50 transition font-bold">Select All</button>
                        <button onclick="toggleAllScripts(false)" class="text-xs px-3 py-1 bg-red-900/30 text-red-400 border border-red-900 rounded hover:bg-red-900/50 transition font-bold">Clear</button>
                    </div>
    
                    <!-- Tabs -->
                    <div class="flex mb-6 bg-gray-900 rounded-lg p-1 border border-gray-700">
                        <button id="hira-tab-btn" onclick="setActiveScriptTab('hira')" class="flex-1 py-2 text-sm font-bold rounded-md transition bg-gray-700 text-white shadow-sm">Hiragana</button>
                        <button id="kata-tab-btn" onclick="setActiveScriptTab('kata')" class="flex-1 py-2 text-sm font-bold rounded-md transition text-gray-400 hover:text-white hover:bg-gray-800">Katakana</button>
                    </div>
    
                    <div id="hira-selection" class="kana-selection-tab space-y-8 pb-8"></div>
                    <div id="kata-selection" class="kana-selection-tab space-y-8 pb-8 hidden"></div>
                </section>
            </div>

            <div class="flex-none pt-6 mt-4 border-t border-gray-700 bg-gray-800 z-10 px-4 pb-4">
                <button onclick="applySettings()" class="btn-primary w-full py-4 rounded-xl text-lg font-bold shadow-lg">
                    Apply Changes
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- KANA DATABASE ---
        
        const KANA_MAP = {
            'a': ['„ÅÇ', '„Ç¢'], 'i': ['„ÅÑ', '„Ç§'], 'u': ['„ÅÜ', '„Ç¶'], 'e': ['„Åà', '„Ç®'], 'o': ['„Åä', '„Ç™'],
            'ka': ['„Åã', '„Ç´'], 'ki': ['„Åç', '„Ç≠'], 'ku': ['„Åè', '„ÇØ'], 'ke': ['„Åë', '„Ç±'], 'ko': ['„Åì', '„Ç≥'],
            'sa': ['„Åï', '„Çµ'], 'shi': ['„Åó', '„Ç∑'], 'su': ['„Åô', '„Çπ'], 'se': ['„Åõ', '„Çª'], 'so': ['„Åù', '„ÇΩ'],
            'ta': ['„Åü', '„Çø'], 'chi': ['„Å°', '„ÉÅ'], 'tsu': ['„Å§', '„ÉÑ'], 'te': ['„Å¶', '„ÉÜ'], 'to': ['„Å®', '„Éà'],
            'na': ['„Å™', '„Éä'], 'ni': ['„Å´', '„Éã'], 'nu': ['„Å¨', '„Éå'], 'ne': ['„Å≠', '„Éç'], 'no': ['„ÅÆ', '„Éé'],
            'ha': ['„ÅØ', '„Éè'], 'hi': ['„Å≤', '„Éí'], 'fu': ['„Åµ', '„Éï'], 'he': ['„Å∏', '„Éò'], 'ho': ['„Åª', '„Éõ'],
            'ma': ['„Åæ', '„Éû'], 'mi': ['„Åø', '„Éü'], 'mu': ['„ÇÄ', '„É†'], 'me': ['„ÇÅ', '„É°'], 'mo': ['„ÇÇ', '„É¢'],
            'ya': ['„ÇÑ', '„É§'], 'yu': ['„ÇÜ', '„É¶'], 'yo': ['„Çà', '„É®'],
            'ra': ['„Çâ', '„É©'], 'ri': ['„Çä', '„É™'], 'ru': ['„Çã', '„É´'], 're': ['„Çå', '„É¨'], 'ro': ['„Çç', '„É≠'],
            'wa': ['„Çè', '„ÉØ'], 'wo': ['„Çí', '„É≤'], 'n': ['„Çì', '„É≥'],
            
            // Dakuon
            'ga': ['„Åå', '„Ç¨'], 'gi': ['„Åé', '„ÇÆ'], 'gu': ['„Åê', '„Ç∞'], 'ge': ['„Åí', '„Ç≤'], 'go': ['„Åî', '„Ç¥'],
            'za': ['„Åñ', '„Ç∂'], 'ji': ['„Åò', '„Ç∏'], 'zu': ['„Åö', '„Ç∫'], 'ze': ['„Åú', '„Çº'], 'zo': ['„Åû', '„Çæ'],
            'da': ['„Å†', '„ÉÄ'], 'dji': ['„Å¢', '„ÉÇ'], 'dzu': ['„Å•', '„ÉÖ'], 'de': ['„Åß', '„Éá'], 'do': ['„Å©', '„Éâ'],
            'ba': ['„Å∞', '„Éê'], 'bi': ['„Å≥', '„Éì'], 'bu': ['„Å∂', '„Éñ'], 'be': ['„Åπ', '„Éô'], 'bo': ['„Åº', '„Éú'],
            'pa': ['„Å±', '„Éë'], 'pi': ['„Å¥', '„Éî'], 'pu': ['„Å∑', '„Éó'], 'pe': ['„Å∫', '„Éö'], 'po': ['„ÅΩ', '„Éù'],
            
            // Yoon
            'kya': ['„Åç„ÇÉ', '„Ç≠„É£'], 'kyu': ['„Åç„ÇÖ', '„Ç≠„É•'], 'kyo': ['„Åç„Çá', '„Ç≠„Éß'],
            'sha': ['„Åó„ÇÉ', '„Ç∑„É£'], 'shu': ['„Åó„ÇÖ', '„Ç∑„É•'], 'sho': ['„Åó„Çá', '„Ç∑„Éß'],
            'cha': ['„Å°„ÇÉ', '„ÉÅ„É£'], 'chu': ['„Å°„ÇÖ', '„ÉÅ„É•'], 'cho': ['„Å°„Çá', '„ÉÅ„Éß'],
            'nya': ['„Å´„ÇÉ', '„Éã„É£'], 'nyu': ['„Å´„ÇÖ', '„Éã„É•'], 'nyo': ['„Å´„Çá', '„Éã„Éß'],
            'hya': ['„Å≤„ÇÉ', '„Éí„É£'], 'hyu': ['„Å≤„ÇÖ', '„Éí„Éß'], 'hyo': ['„Å≤„Çá', '„Éí„Éß'],
            'mya': ['„Åø„ÇÉ', '„Éü„É£'], 'myu': ['„Åø„ÇÖ', '„Éü„É•'], 'myo': ['„Åø„Çá', '„Éü„Éß'],
            'rya': ['„Çä„ÇÉ', '„É™„É£'], 'ryu': ['„Çä„ÇÖ', '„É™„É•'], 'ryo': ['„Çä„Çá', '„É™„Éß'],
            'gya': ['„Åé„ÇÉ', '„ÇÆ„É£'], 'gyu': ['„Åé„ÇÖ', '„ÇÆ„Éß'], 'gyo': ['„Åé„Çá', '„ÇÆ„Éß'],
            'ja': ['„Åò„ÇÉ', '„Ç∏„É£'], 'ju': ['„Åò„ÇÖ', '„Ç∏„É•'], 'jo': ['„Åò„Çá', '„Ç∏„Éß'],
            'bya': ['„Å≥„ÇÉ', '„Éì„É£'], 'byu': ['„Å≥„ÇÖ', '„Éì„É•'], 'byo': ['„Å≥„Çá', '„Éì„Éß'],
            'pya': ['„Å¥„ÇÉ', '„Éî„É£'], 'pyu': ['„Å¥„ÇÖ', '„Éî„É•'], 'pyo': ['„Å¥„Çá', '„Éî„Éß'],
        };
        
        const ALT_ROMAJI = {
            'shi': ['si', 'ci'], 'chi': ['ti'], 'tsu': ['tu'], 'fu': ['hu'], 
            'ji': ['zi'], 'dji': ['di'], 'dzu': ['du'], 
            'ju': ['zyu', 'jyu'], 'jo': ['zyo', 'jyo'], 'ja': ['zya', 'jya'],
            'sha': ['sya'], 'shu': ['syu'], 'sho': ['syo'],
            'cha': ['tya'], 'chu': ['tyu'], 'cho': ['tyo'],
            'kya': ['kya'], 'kyu': ['kyu'], 'kyo': ['kyo'],
            'la': ['ra'], 'li': ['ri'], 'lu': ['ru'], 'le': ['re'], 'lo': ['ro'],
        };

        const BASIC_KANA_MAP = {
            'A-row': ['a', 'i', 'u', 'e', 'o'],
            'K-row': ['ka', 'ki', 'ku', 'ke', 'ko'],
            'S-row': ['sa', 'shi', 'su', 'se', 'so'],
            'T-row': ['ta', 'chi', 'tsu', 'te', 'to'],
            'N-row': ['na', 'ni', 'nu', 'ne', 'no'],
            'H-row': ['ha', 'hi', 'fu', 'he', 'ho'],
            'M-row': ['ma', 'mi', 'mu', 'me', 'mo'],
            'Y-row': ['ya', null, 'yu', null, 'yo'],
            'R-row': ['ra', 'ri', 'ru', 're', 'ro'],
            'W-row': ['wa', null, null, null, 'wo'], 
            'N-row (Lone)': ['n'] 
        };
        const VOICED_MAP = {
            'G-row': ['ga', 'gi', 'gu', 'ge', 'go'],
            'Z/J-row': ['za', 'ji', 'zu', 'ze', 'zo'],
            'D-row': ['da', 'dji', 'dzu', 'de', 'do'],
            'B-row': ['ba', 'bi', 'bu', 'be', 'bo'],
            'P-row': ['pa', 'pi', 'pu', 'pe', 'po'],
        };
        const YOON_MAP = {
            'K-y≈çon': ['kya', null, 'kyu', null, 'kyo'],
            'S-y≈çon': ['sha', null, 'shu', null, 'sho'],
            'C-y≈çon': ['cha', null, 'chu', null, 'cho'],
            'N-y≈çon': ['nya', null, 'nyu', null, 'nyo'],
            'H-y≈çon': ['hya', null, 'hyu', null, 'hyo'],
            'M-y≈çon': ['mya', null, 'myu', null, 'myo'],
            'R-y≈çon': ['rya', null, 'ryu', null, 'ryo'],
            'G-y≈çon': ['gya', null, 'gyu', null, 'gyo'],
            'J-y≈çon': ['ja', null, 'ju', null, 'jo'], 
            'B-y≈çon': ['bya', null, 'byu', null, 'byo'],
            'P-y≈çon': ['pya', null, 'pyu', null, 'pyo'],
        };
        
        const RENDER_SECTIONS = [
            { name: 'Basic (Goj≈´on)', map: BASIC_KANA_MAP }, 
            { name: 'Voiced (Dakuon)', map: VOICED_MAP },
            { name: 'Contracted (Y≈çon)', map: YOON_MAP },
        ];

        // --- STATE ---
        let state = {
            currentRomaji: '',
            currentScriptIdx: 0, // 0 for Hiragana, 1 for Katakana
            score: 0,
            mistakes: 0,
            streak: 0,
            mistakeHistory: [], // Stores strings: "romaji:scriptIdx"
            scriptSelections: {},
            isTimerEnabled: true,
            timeLimit: 3000,
            isStringMode: false,
            stringLength: 3,
            isReviewMode: false,
            timerInterval: null,
            questionStartTime: 0,
            stringQueue: [],
            stringIndex: 0,
            stringMistakesCurrent: 0,
            // New Pause & Timer logic variables
            isPaused: false,
            timerRemaining: 0, 
            lastTimerTick: 0,
            // String mode pause handling
            stringAccumulatedTime: 0,
            stringSegmentStart: 0,
        };

        // --- DOM ELEMENTS ---
        const els = {
            app: document.getElementById('app'),
            views: document.querySelectorAll('.view'),
            currentKana: document.getElementById('current-kana'),
            kanaType: document.getElementById('kana-type'),
            input: document.getElementById('kana-input'),
            feedback: document.getElementById('feedback'),
            score: document.getElementById('score'),
            mistakes: document.getElementById('mistakes'),
            streak: document.getElementById('streak'),
            timerBar: document.getElementById('timer-bar'),
            timerContainer: document.getElementById('timer-mode'),
            modeInfo: document.getElementById('mode-info'),
            settingsPanel: document.getElementById('settings-panel'),
            settingsOverlay: document.getElementById('settings-overlay'),
            timerToggle: document.getElementById('timer-toggle'),
            timeLimitInput: document.getElementById('timer-limit-input'),
            customTimeContainer: document.getElementById('custom-time-container'),
            stringLenInput: document.getElementById('string-len-input'),
            hiraSelection: document.getElementById('hira-selection'),
            kataSelection: document.getElementById('kata-selection'),
            hiraTabBtn: document.getElementById('hira-tab-btn'),
            kataTabBtn: document.getElementById('kata-tab-btn'),
            stringModeBtn: document.getElementById('toggle-string-mode'),
            reviewModeBtn: document.getElementById('review-mode-btn'),
            mistakeCountBtn: document.getElementById('mistake-count-btn'),
            resultsModal: document.getElementById('results-modal'),
            pauseOverlay: document.getElementById('pause-overlay'),
        };

        let activeTab = 'hira';

        // --- INIT ---
        function init() {
            Object.keys(KANA_MAP).forEach(key => {
                state.scriptSelections[key] = [true, true];
            });
            renderSettings();
            updateUIStats();
            updateModeUI();
        }

        function changeView(viewId) {
            // Ensure we unpause when changing views to prevent stuck state
            if(state.isPaused) togglePause(); 
            
            els.views.forEach(v => v.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            if(viewId === 'trainer-view') {
                nextQuestion();
                els.input.focus();
            }
        }

        function togglePause() {
            // Don't pause if in settings or results
            if(!els.resultsModal.classList.contains('hidden') || !els.settingsPanel.classList.contains('hidden')) return;

            state.isPaused = !state.isPaused;

            if(state.isPaused) {
                // STOP
                clearInterval(state.timerInterval);
                els.pauseOverlay.classList.remove('hidden');
                els.input.disabled = true;

                // Handle string mode timing
                if(state.isStringMode) {
                    const now = Date.now();
                    state.stringAccumulatedTime += (now - state.stringSegmentStart);
                }
            } else {
                // RESUME
                els.pauseOverlay.classList.add('hidden');
                els.input.disabled = false;
                els.input.focus();

                // Handle string mode timing
                if(state.isStringMode) {
                    state.stringSegmentStart = Date.now();
                } else {
                    // Resume Timer Mode
                    if(state.isTimerEnabled) startTimer();
                }
            }
        }

        function toggleSettings(show) {
            if(show) {
                // Auto pause game when opening settings
                if(!state.isPaused && !els.views[0].classList.contains('hidden') === false) { // if not intro view
                     togglePause();
                }
                els.settingsPanel.classList.remove('hidden');
                els.settingsOverlay.classList.remove('hidden');
            } else {
                els.settingsPanel.classList.add('hidden');
                els.settingsOverlay.classList.add('hidden');
                // Don't auto-resume here, let user click resume or close to decide, 
                // but usually settings changes trigger applySettings which resets game.
            }
        }

        function setActiveScriptTab(tab) {
            activeTab = tab;
            if(tab === 'hira') {
                els.hiraSelection.classList.remove('hidden');
                els.kataSelection.classList.add('hidden');
                els.hiraTabBtn.className = "flex-1 py-2 text-sm font-bold rounded-md transition bg-gray-700 text-white shadow-sm";
                els.kataTabBtn.className = "flex-1 py-2 text-sm font-bold rounded-md transition text-gray-400 hover:text-white hover:bg-gray-800";
            } else {
                els.hiraSelection.classList.add('hidden');
                els.kataSelection.classList.remove('hidden');
                els.hiraTabBtn.className = "flex-1 py-2 text-sm font-bold rounded-md transition text-gray-400 hover:text-white hover:bg-gray-800";
                els.kataTabBtn.className = "flex-1 py-2 text-sm font-bold rounded-md transition bg-gray-700 text-white shadow-sm";
            }
        }

        function renderSettings() {
            renderScriptTab(0, els.hiraSelection);
            renderScriptTab(1, els.kataSelection);
        }

        function renderScriptTab(scriptIndex, container) {
            container.innerHTML = '';
            RENDER_SECTIONS.forEach(section => {
                const flatKeys = Object.values(section.map).flat().filter(Boolean);
                const isGroupSelected = flatKeys.every(k => state.scriptSelections[k][scriptIndex]);

                const header = document.createElement('div');
                header.className = "flex justify-between items-center pt-6 border-t border-gray-700 first:border-0 first:pt-0";
                header.innerHTML = `
                    <h4 class="font-bold text-gray-500 uppercase tracking-wider text-xs">${section.name}</h4>
                    <button onclick="toggleGroup(['${flatKeys.join("','")}'], ${scriptIndex}, ${!isGroupSelected})" 
                            class="text-[10px] px-2 py-1 border border-gray-600 text-gray-400 rounded hover:bg-gray-700 hover:text-white transition uppercase tracking-wider">
                        ${isGroupSelected ? 'Deselect Group' : 'Select Group'}
                    </button>
                `;
                container.appendChild(header);

                Object.entries(section.map).forEach(([rowName, keys]) => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = "mt-4";
                    
                    const rowHeader = document.createElement('div');
                    rowHeader.className = "flex justify-between items-center mb-2 px-1";
                    const isRowSelected = keys.filter(Boolean).every(k => state.scriptSelections[k][scriptIndex]);
                    rowHeader.innerHTML = `
                        <span class="text-[10px] font-bold uppercase text-gray-500 tracking-wider">${rowName}</span>
                        <button onclick="toggleGroup(['${keys.filter(Boolean).join("','")}'], ${scriptIndex}, ${!isRowSelected})" class="text-[10px] text-gray-500 hover:text-white transition">
                            ${isRowSelected ? 'None' : 'All'}
                        </button>
                    `;
                    rowDiv.appendChild(rowHeader);

                    const grid = document.createElement('div');
                    grid.className = "grid grid-cols-5 gap-2";
                    
                    keys.forEach(key => {
                        if(!key) {
                            grid.innerHTML += `<div class="aspect-square"></div>`;
                            return;
                        }
                        const isSelected = state.scriptSelections[key][scriptIndex];
                        const char = KANA_MAP[key][scriptIndex];
                        const card = document.createElement('div');
                        card.className = `kana-group-card rounded-lg aspect-square flex flex-col items-center justify-center ${isSelected ? 'selected' : 'deselected'}`;
                        card.onclick = () => toggleSingle(key, scriptIndex);
                        card.innerHTML = `
                            <span class="text-xl font-bold mb-1">${char}</span>
                            <span class="text-[10px] uppercase opacity-70">${key}</span>
                        `;
                        grid.appendChild(card);
                    });
                    rowDiv.appendChild(grid);
                    container.appendChild(rowDiv);
                });
            });
        }

        function toggleSingle(key, idx) {
            state.scriptSelections[key][idx] = !state.scriptSelections[key][idx];
            renderSettings();
        }

        function toggleGroup(keys, idx, val) {
            keys.forEach(k => state.scriptSelections[k][idx] = val);
            renderSettings();
        }

        function toggleAllScripts(val) {
            Object.keys(state.scriptSelections).forEach(k => {
                state.scriptSelections[k] = [val, val];
            });
            renderSettings();
        }

        function toggleCustomTimeInput() {
            const checked = els.timerToggle.checked;
            if(checked) {
                els.customTimeContainer.style.maxHeight = '5rem';
                els.customTimeContainer.style.opacity = '1';
            } else {
                els.customTimeContainer.style.maxHeight = '0';
                els.customTimeContainer.style.opacity = '0';
            }
        }

        function adjustStringLength(delta) {
            let newLen = state.stringLength + delta;
            if(newLen < 2) newLen = 2;
            // No upper limit check anymore
            state.stringLength = newLen;
            els.stringLenInput.value = newLen;
        }

        function setStringLength(val) {
            let newLen = parseInt(val);
            if(isNaN(newLen) || newLen < 2) newLen = 2;
            state.stringLength = newLen;
            els.stringLenInput.value = newLen;
        }

        function applySettings() {
            state.isTimerEnabled = els.timerToggle.checked;
            state.timeLimit = parseFloat(els.timeLimitInput.value) * 1000;
            state.score = 0;
            state.mistakes = 0;
            state.streak = 0;
            state.mistakeHistory = [];
            state.isReviewMode = false;
            
            // Unpause if paused by settings
            state.isPaused = false;
            els.pauseOverlay.classList.add('hidden');
            els.input.disabled = false;

            updateUIStats();
            updateModeUI();
            toggleSettings(false);
            nextQuestion();
        }

        function toggleStringModeUI() {
            state.isStringMode = !state.isStringMode;
            updateModeUI();
            nextQuestion();
        }

        function toggleReviewMode() {
            state.isReviewMode = !state.isReviewMode;
            updateModeUI();
            nextQuestion();
        }

        function updateModeUI() {
            if(state.isStringMode) {
                els.stringModeBtn.innerHTML = `<span>üìö</span> String Mode: ON (${state.stringLength})`;
                els.stringModeBtn.className = "px-4 py-2 bg-blue-900/40 text-blue-400 border border-blue-900 rounded-lg text-sm font-semibold hover:bg-blue-900/60 transition flex items-center gap-2";
                els.timerContainer.classList.add('opacity-0');
                els.modeInfo.textContent = "Complete the sequence";
            } else {
                els.stringModeBtn.innerHTML = `<span>üìö</span> String Mode: OFF`;
                els.stringModeBtn.className = "px-4 py-2 bg-gray-700 text-gray-200 rounded-lg text-sm font-semibold hover:bg-gray-600 transition flex items-center gap-2";
                els.timerContainer.classList.remove('opacity-0');
                els.modeInfo.textContent = state.isTimerEnabled 
                    ? `Timer: ${(state.timeLimit/1000).toFixed(1)}s` 
                    : `Untimed Practice`;
            }

            const count = new Set(state.mistakeHistory).size;
            els.mistakeCountBtn.textContent = count;
            if(count > 0 && !state.isStringMode) {
                els.reviewModeBtn.classList.remove('hidden');
                if(state.isReviewMode) {
                    els.reviewModeBtn.className = "px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-semibold hover:bg-red-700 transition flex items-center gap-2";
                    els.reviewModeBtn.innerHTML = `<span>üöë</span> Exit Review`;
                } else {
                    els.reviewModeBtn.className = "px-4 py-2 bg-red-900/30 border border-red-900 text-red-400 rounded-lg text-sm font-semibold hover:bg-red-900/50 transition flex items-center gap-2";
                    els.reviewModeBtn.innerHTML = `<span>üöë</span> Review (${count})`;
                }
            } else {
                els.reviewModeBtn.classList.add('hidden');
                if(state.isReviewMode) {
                    state.isReviewMode = false;
                }
            }
        }

        // --- GAME LOGIC ---

        function getActiveDeck() {
            let deck = [];
            if(state.isReviewMode) {
                return [...new Set(state.mistakeHistory)];
            }
            Object.keys(state.scriptSelections).forEach(key => {
                if(state.scriptSelections[key][0] || state.scriptSelections[key][1]) {
                    deck.push(key);
                }
            });
            return deck;
        }

        function nextQuestion() {
            clearInterval(state.timerInterval);
            
            // Reset Pause State on new question (safety)
            state.isPaused = false;
            els.pauseOverlay.classList.add('hidden');
            els.input.disabled = false;
            
            els.input.value = '';
            els.input.classList.remove('input-correct', 'input-incorrect');
            els.input.focus();
            
            els.timerBar.style.width = '100%';
            els.timerBar.className = 'timer-bar bg-blue-500 absolute top-0 left-0 h-full';
            
            els.feedback.style.opacity = '0';
            els.feedback.classList.remove('translate-y-0');
            els.feedback.classList.add('translate-y-2');

            const deck = getActiveDeck();
            
            if(deck.length === 0) {
                els.currentKana.textContent = "ü§î";
                els.kanaType.textContent = "Deck Empty";
                return;
            }

            if(state.isStringMode) {
                setupStringRound(deck);
            } else {
                setupSingleRound(deck);
            }
        }

        function skipQuestion() {
            clearInterval(state.timerInterval);
            state.streak = 0; 
            
            if(!state.isStringMode) {
                const mistakeKey = `${state.currentRomaji}:${state.currentScriptIdx}`;
                state.mistakeHistory.push(mistakeKey);
            }
            
            updateUIStats();
            updateModeUI();
            
            if(state.isStringMode) {
                 finishStringRound();
                 // Removed nextQuestion() here because finishStringRound opens modal, 
                 // and closing modal triggers nextQuestion via closeResultsModal.
            } else {
                // LOCK UI AND SHOW ANSWER
                els.input.disabled = true;
                showFeedback(false, state.currentRomaji); 
                setTimeout(nextQuestion, 2000); // 2s delay so user can see answer
            }
        }

        function setupSingleRound(deck) {
            els.currentKana.className = "kana-char font-bold text-white mb-6 flex items-center justify-center select-none whitespace-pre single-mode";
            
            let romaji, scriptIdx;

            if (state.isReviewMode) {
                // Deck contains "romaji:scriptIdx" strings
                const item = deck[Math.floor(Math.random() * deck.length)];
                const parts = item.split(':');
                romaji = parts[0];
                scriptIdx = parseInt(parts[1]);
            } else {
                // Deck contains plain "romaji" strings
                romaji = deck[Math.floor(Math.random() * deck.length)];
                const opts = state.scriptSelections[romaji];
                
                if(opts[0] && opts[1]) scriptIdx = Math.random() < 0.5 ? 0 : 1;
                else if(opts[0]) scriptIdx = 0;
                else scriptIdx = 1;
            }

            state.currentRomaji = romaji;
            state.currentScriptIdx = scriptIdx;

            els.currentKana.textContent = KANA_MAP[romaji][scriptIdx];
            els.kanaType.textContent = scriptIdx === 0 ? "Hiragana" : "Katakana";
            
            // Timer logic reset
            state.timerRemaining = state.timeLimit;
            if(state.isTimerEnabled) startTimer();
        }

        function setupStringRound(deck) {
            els.currentKana.className = "kana-char font-bold text-gray-300 mb-2 select-none whitespace-pre string-mode";
            
            state.stringQueue = [];
            state.stringIndex = 0;
            state.stringMistakesCurrent = 0;
            
            for(let i=0; i<state.stringLength; i++) {
                let romaji, scriptIdx;
                
                if (state.isReviewMode) {
                    const item = deck[Math.floor(Math.random() * deck.length)];
                    const parts = item.split(':');
                    romaji = parts[0];
                    scriptIdx = parseInt(parts[1]);
                } else {
                    romaji = deck[Math.floor(Math.random() * deck.length)];
                    const opts = state.scriptSelections[romaji];
                    if(opts[0] && opts[1]) scriptIdx = Math.random() < 0.5 ? 0 : 1;
                    else if(opts[0]) scriptIdx = 0;
                    else scriptIdx = 1;
                }
                
                state.stringQueue.push({
                    romaji: romaji,
                    kana: KANA_MAP[romaji][scriptIdx],
                    scriptIdx: scriptIdx,
                    status: 'pending'
                });
            }
            
            renderStringDisplay();
            els.kanaType.textContent = `Progress: 0/${state.stringLength}`;
            
            // String Mode Timing Reset
            state.stringAccumulatedTime = 0;
            state.stringSegmentStart = Date.now();
        }

        function renderStringDisplay() {
            let html = '';
            state.stringQueue.forEach((item, idx) => {
                let classes = "mx-1 px-1 ";
                if(idx < state.stringIndex) {
                    if(item.status === 'mistake') classes += "string-incorrect";
                    else classes += "string-correct";
                } else if(idx === state.stringIndex) {
                    classes += "string-target border-b-2 border-blue-500";
                } else {
                    classes += "string-pending opacity-40";
                }
                html += `<span class="${classes}">${item.kana}</span>`;
            });
            els.currentKana.innerHTML = html;
        }

        function handleInput() {
            // Prevent input if paused (redundant since disabled, but safe)
            if(state.isPaused) return;

            const val = els.input.value.toLowerCase().trim();
            if(!val) return;

            if(state.isStringMode) {
                checkStringInput(val);
            } else {
                checkSingleInput(val);
            }
        }

        function checkSingleInput(val) {
            const correct = state.currentRomaji;
            let isMatch = (val === correct);
            if(!isMatch && ALT_ROMAJI[correct]) {
                isMatch = ALT_ROMAJI[correct].includes(val);
            }

            if(isMatch) {
                state.score++;
                state.streak++;
                
                if(state.isReviewMode) {
                    const keyToRemove = `${correct}:${state.currentScriptIdx}`;
                    const idx = state.mistakeHistory.indexOf(keyToRemove);
                    if(idx > -1) state.mistakeHistory.splice(idx, 1);
                }

                showFeedback(true, correct);
                updateUIStats();
                updateModeUI(); 
                
                setTimeout(nextQuestion, 150);
            }
        }

        function checkStringInput(val) {
            if(state.stringIndex >= state.stringQueue.length) return;

            const targetItem = state.stringQueue[state.stringIndex];
            const target = targetItem.romaji;
            
            let isMatch = (val === target);
            if(!isMatch && ALT_ROMAJI[target]) isMatch = ALT_ROMAJI[target].includes(val);

            if(isMatch) {
                state.stringIndex++;
                els.input.value = '';
                els.kanaType.textContent = `Progress: ${state.stringIndex}/${state.stringLength}`;
                renderStringDisplay();
                
                if(state.stringIndex >= state.stringQueue.length) {
                    finishStringRound();
                }
            } else {
                let isValidPrefix = target.startsWith(val);
                if(!isValidPrefix && ALT_ROMAJI[target]) {
                    isValidPrefix = ALT_ROMAJI[target].some(alt => alt.startsWith(val));
                }
                
                if(!isValidPrefix) {
                    state.stringMistakesCurrent++;
                    const mistakeKey = `${target}:${targetItem.scriptIdx}`;
                    state.mistakeHistory.push(mistakeKey);
                    
                    targetItem.status = 'mistake';
                    
                    els.input.value = '';
                    els.input.classList.add('input-incorrect');
                    setTimeout(() => els.input.classList.remove('input-incorrect'), 200);
                    renderStringDisplay();
                    updateUIStats();
                }
            }
        }

        function finishStringRound() {
            // Calculate total time
            const now = Date.now();
            const totalDuration = state.stringAccumulatedTime + (now - state.stringSegmentStart);
            const timeTaken = totalDuration / 1000;
            
            const totalChars = state.stringQueue.reduce((acc, item) => acc + item.romaji.length, 0);
            const wpm = Math.round((totalChars / 5) / (timeTaken / 60));

            // Calculate 'Perfect' count: Only count items that were completed AND never marked as mistake
            const correctCount = state.stringQueue.slice(0, state.stringIndex).filter(item => item.status !== 'mistake').length;
            const accuracy = Math.round((correctCount / state.stringLength) * 100);

            state.score += correctCount;
            // Any items skipped or mistyped count towards mistakes
            // (Total Length - Perfect Count) is the number of flawed/skipped items
            state.mistakes += state.stringMistakesCurrent + (state.stringLength - state.stringIndex);
            
            if(state.stringMistakesCurrent === 0 && state.stringIndex === state.stringLength) state.streak++;
            else state.streak = 0;
            
            updateUIStats();
            
            // SHOW SUMMARY NUMBERS
            document.getElementById('str-total-length').textContent = state.stringLength;
            document.getElementById('str-correct-count').textContent = correctCount;

            document.getElementById('str-time-taken').textContent = timeTaken.toFixed(2) + 's';
            document.getElementById('str-wpm').textContent = wpm;
            document.getElementById('str-accuracy').textContent = accuracy + '%';
            document.getElementById('str-mistyped-kana').textContent = state.stringMistakesCurrent;
            
            els.resultsModal.classList.remove('hidden');
        }

        function closeResultsModal() {
            els.resultsModal.classList.add('hidden');
            nextQuestion();
        }

        function startTimer() {
            state.lastTimerTick = Date.now();
            
            state.timerInterval = setInterval(() => {
                const now = Date.now();
                const delta = now - state.lastTimerTick;
                state.lastTimerTick = now;

                state.timerRemaining -= delta;
                
                const pct = (state.timerRemaining / state.timeLimit) * 100;
                els.timerBar.style.width = `${Math.max(0, pct)}%`;
                
                if(pct < 30) els.timerBar.className = 'timer-bar bg-red-600 absolute top-0 left-0 h-full';
                else if(pct < 60) els.timerBar.className = 'timer-bar bg-yellow-500 absolute top-0 left-0 h-full';
                else els.timerBar.className = 'timer-bar bg-blue-500 absolute top-0 left-0 h-full';
                
                if(state.timerRemaining <= 0) {
                    handleTimeout();
                }
            }, 30); 
        }

        function handleTimeout() {
            clearInterval(state.timerInterval);
            state.mistakes++;
            state.streak = 0;
            
            const mistakeKey = `${state.currentRomaji}:${state.currentScriptIdx}`;
            state.mistakeHistory.push(mistakeKey);
            
            // LOCK UI AND SHOW ANSWER
            els.input.disabled = true; 
            showFeedback(false, state.currentRomaji);
            updateUIStats();
            updateModeUI();

            setTimeout(nextQuestion, 2000); // 2s delay
        }

        function showFeedback(success, text) {
            els.feedback.textContent = success ? "Correct!" : `Answer: ${text}`;
            els.feedback.className = `h-8 text-lg font-bold text-center tracking-wider transition-all duration-300 transform translate-y-0 opacity-100 ${success ? 'text-green-400' : 'text-red-400'}`;
            
            if(success) {
                els.input.classList.add('input-correct');
            } else {
                els.input.classList.add('input-incorrect');
                // SHOW ANSWER IN INPUT BOX
                els.input.value = text;
            }
        }

        function updateUIStats() {
            els.score.textContent = state.score;
            els.streak.textContent = state.streak;
            els.mistakes.textContent = state.mistakes;
        }

        init();

    </script>
</body>
</html>